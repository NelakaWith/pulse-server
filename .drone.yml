---
kind: pipeline
type: docker
name: test-on-PR

# Run tests on PR creation
trigger:
  event:
    - pull_request

steps:
  - name: install-dependencies
    image: node:20-alpine
    commands:
      - npm ci

  - name: run-tests
    image: node:20-alpine
    environment:
      NODE_ENV: test
      # Mock API keys for testing
      API_KEY_AUTH_ENABLED: "true"
      API_KEYS: pulse-dev-key-123
      # Use secrets if available, otherwise empty (tests should handle missing keys)
      OPENROUTER_API_KEY:
        from_secret: openrouter_api_key
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - npm run test:ci

  - name: lint-commits
    image: node:20-alpine
    commands:
      - npx commitlint --from HEAD~1 --to HEAD --verbose

  - name: build-dry-run
    image: alpine:latest
    commands:
      - echo "üß™ Testing build steps (dry-run)..."
      # Test build and copy process
      - mkdir -p /tmp/deploy-test
      - cp -r . /tmp/deploy-test/
      # Exclude dev files
      - rm -rf /tmp/deploy-test/node_modules
      - rm -rf /tmp/deploy-test/.git
      - rm -rf /tmp/deploy-test/tests
      # Verify required files exist
      - echo "‚úÖ Checking required files..."
      - test -f /tmp/deploy-test/server.js && echo "‚úÖ server.js found"
      - test -f /tmp/deploy-test/package.json && echo "‚úÖ package.json found"
      - test -f /tmp/deploy-test/ecosystem.config.js && echo "‚úÖ ecosystem.config.js found"
      - test -d /tmp/deploy-test/routes && echo "‚úÖ routes/ found"
      - test -d /tmp/deploy-test/middleware && echo "‚úÖ middleware/ found"
      - test -d /tmp/deploy-test/services && echo "‚úÖ services/ found"
      - test -d /tmp/deploy-test/utils && echo "‚úÖ utils/ found"
      # Show what would be deployed
      - echo "üì¶ Files to be deployed:"
      - ls -lah /tmp/deploy-test/ | grep -E "^d|server.js|package|ecosystem"
      - echo "üß™ Build dry-run complete!"

---
kind: pipeline
type: docker
name: build-and-deploy

# Run only when release tag is created (v*.*.*)
trigger:
  event:
    - tag
  ref:
    - refs/tags/v*

steps:
  - name: install-dependencies
    image: node:20-alpine
    commands:
      - npm ci

  - name: run-tests
    image: node:20-alpine
    environment:
      NODE_ENV: test
      API_KEY_AUTH_ENABLED: "true"
      API_KEYS: pulse-dev-key-123
      OPENROUTER_API_KEY:
        from_secret: openrouter_api_key
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - npm run test:ci

  - name: build-and-copy
    image: alpine:latest
    commands:
      - echo "Building application..."
      # Copy necessary files to deployment directory
      - mkdir -p /tmp/deploy
      - cp -r . /tmp/deploy/
      # Exclude dev files
      - rm -rf /tmp/deploy/node_modules
      - rm -rf /tmp/deploy/.git
      - rm -rf /tmp/deploy/tests
      - echo "Build complete"
    volumes:
      - name: deploy
        path: /tmp/deploy

  - name: copy-to-server
    image: appleboy/drone-scp
    settings:
      host:
        from_secret: deploy_host
      username:
        from_secret: deploy_username
      key:
        from_secret: deploy_ssh_key
      port: 22
      target: /var/www/pulse-server
      source:
        - server.js
        - package.json
        - package-lock.json
        - .env.production
        - ecosystem.config.js
        - routes/**
        - middleware/**
        - services/**
        - utils/**
      strip_components: 0
      overwrite: true
      rm: false

  - name: install-production-deps
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: deploy_host
      username:
        from_secret: deploy_username
      key:
        from_secret: deploy_ssh_key
      port: 22
      script:
        - cd /var/www/pulse-server
        - npm ci --only=production

  - name: health-check-before-deploy
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: deploy_host
      username:
        from_secret: deploy_username
      key:
        from_secret: deploy_ssh_key
      port: 22
      script:
        - echo "Checking server health..."
        - pm2 describe pulse-server || echo "App not running yet"

  - name: deploy-with-pm2
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: deploy_host
      username:
        from_secret: deploy_username
      key:
        from_secret: deploy_ssh_key
      port: 22
      script:
        - cd /var/www/pulse-server
        - pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
        - pm2 save

  - name: health-check-after-deploy
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: deploy_host
      username:
        from_secret: deploy_username
      key:
        from_secret: deploy_ssh_key
      port: 22
      script:
        - sleep 5
        - pm2 describe pulse-server
        - pm2 logs pulse-server --lines 20 --nostream
        # Check if app is responding
        - curl -f http://localhost:3000/health || exit 1

  - name: notify-success
    image: appleboy/drone-telegram
    settings:
      token:
        from_secret: telegram_token
      to:
        from_secret: telegram_chat_id
      message: |
        ‚úÖ Deployment successful!

        Repository: {{ repo.name }}
        Branch: {{ commit.branch }}
        Commit: {{ commit.sha }}
        Author: {{ commit.author }}
        Message: {{ commit.message }}
    when:
      status:
        - success

  - name: notify-failure
    image: appleboy/drone-telegram
    settings:
      token:
        from_secret: telegram_token
      to:
        from_secret: telegram_chat_id
      message: |
        ‚ùå Deployment failed!

        Repository: {{ repo.name }}
        Branch: {{ commit.branch }}
        Commit: {{ commit.sha }}
        Author: {{ commit.author }}

volumes:
  - name: deploy
    temp: {}

---
kind: pipeline
type: docker
name: release

# Automatically create release when tag is pushed
trigger:
  event:
    - tag
  ref:
    - refs/tags/v*

steps:
  - name: create-github-release
    image: plugins/github-release
    settings:
      api_key:
        from_secret: github_token
      title: "Release ${DRONE_TAG}"
      note: CHANGELOG.md
      files:
        - package.json
        - CHANGELOG.md
    when:
      event:
        - tag

  - name: notify-release
    image: appleboy/drone-telegram
    settings:
      token:
        from_secret: telegram_token
      to:
        from_secret: telegram_chat_id
      message: |
        üöÄ New release published!

        Tag: ${DRONE_TAG}
        Repository: {{ repo.name }}
        Author: {{ commit.author }}
    when:
      status:
        - success
      event:
        - tag
